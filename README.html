<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Static Builds Of Libclang 10</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Aditya Siram" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.cacheClassElem = elem.className;
         elem.cacheClassTarget = target.className;
         target.className = "code-highlighted";
         elem.className   = "code-highlighted";
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(elem.cacheClassElem)
         elem.className = elem.cacheClassElem;
       if(elem.cacheClassTarget)
         target.className = elem.cacheClassTarget;
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<h1 class="title">Static Builds Of Libclang 10</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org532fd28">1. Introduction</a></li>
<li><a href="#orgac51aab">2. Motivation</a></li>
<li><a href="#org108dc6c">3. Getting Started</a></li>
<li><a href="#org468c3da">4. Implementation</a>
<ul>
<li><a href="#orgceede4a">4.1. Preamble</a></li>
<li><a href="#org4e26b51">4.2. Clang and NCurses Download URLs</a></li>
<li><a href="#org8c512eb">4.3. Download Libclang, NCurses and Z3</a></li>
<li><a href="#orgc7a0b46">4.4. Configure NCurses as an external project</a></li>
<li><a href="#orgd71fb90">4.5. Setup CMake Paths And Includes</a></li>
<li><a href="#orga2c72c8">4.6. Build A Static Libclang</a></li>
<li><a href="#org1d61a27">4.7. Helper Modules</a>
<ul>
<li><a href="#org752a060">4.7.1. Build Time Downloads (Download.cmake)</a></li>
<li><a href="#org8ac8648">4.7.2. Libclang sources, headers and static libs (LibClangBuild.cmake)</a></li>
<li><a href="#orgeb94d87">4.7.3. Add absolute path to sources and headers (LibClangBuild.cmake)</a></li>
<li><a href="#org3a7b179">4.7.4. Build AR Bundling Script (ARBundle.cmake)</a></li>
</ul>
</li>
<li><a href="#orga32cdbf">4.8. Examples</a>
<ul>
<li><a href="#org6c97d44">4.8.1. Static Makefile</a></li>
<li><a href="#org577874d">4.8.2. Example Visitor</a></li>
<li><a href="#orgc298424">4.8.3. Sample C++ File</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org532fd28" class="outline-2">
<h2 id="org532fd28"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
This package consists of a set of <a href="https://cmake.org">CMake</a> scripts that download and compile
<a href="https://clang.llvm.org/docs/Tooling.html">libclang</a> into a single large static archive which bundles all LLVM and third
party dependencies so applications which link against it can be easily deployed.
Currently it only works on Linux (tested on Ubuntu 19.04 and Manjaro) and macOS
Mojave. Windows is the next big priority; I just haven&rsquo;t gotten to it yet.
</p>

<p>
It does not build <code>LLVM</code> and <code>libclang</code> from scratch, that would take 5-7 hours,
instead it reuses the <a href="https://releases.llvm.org/download.html">prebuilt LLVM</a> static libraries provided by the project for
each platform and only re-builds the <code>libclang</code> part. On my 6 year old i5
Thinkpad with 16 GB RAM after the downloads completed the whole process
took about 7 minutes.
</p>

<p>
To convince you it works as advertised the package also ships with a little
example app <code>clang_visitor</code> that traverses some C++ AST nodes and here are its
runtime dependencies on Linux:
</p>
<pre class="example">
&gt; $ ldd ./clang_visitor
	linux-vdso.so.1 (0x00007ffce8bfb000)
	libstdc++.so.6 =&gt; /usr/lib/libstdc++.so.6 (0x00007fdb9954a000)
	libm.so.6 =&gt; /usr/lib/libm.so.6 (0x00007fdb99404000)
	libdl.so.2 =&gt; /usr/lib/libdl.so.2 (0x00007fdb993ff000)
	libpthread.so.0 =&gt; /usr/lib/libpthread.so.0 (0x00007fdb993dd000)
	libgcc_s.so.1 =&gt; /usr/lib/libgcc_s.so.1 (0x00007fdb993c3000)
	libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007fdb991fd000)
	/lib64/ld-linux-x86-64.so.2 =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x00007fdb9ea9b000)
</pre>
<p>
&#x2026; and on macOS Mojave:
</p>
<pre class="example">
&gt; otool -L clang_visitor
clang_visitor:
	/usr/lib/libz.1.dylib (compatibility version 1.0.0, current version 1.2.11)
	/usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 400.9.4)
	/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1252.250.1)
</pre>
</div>
</div>
<div id="outline-container-orgac51aab" class="outline-2">
<h2 id="orgac51aab"><span class="section-number-2">2</span> Motivation</h2>
<div class="outline-text-2" id="text-2">
<p>
Currently the best way statically analyze C and C++ source is <a href="https://clang.llvm.org/docs/Tooling.html">libclang</a>.
Unfortunately applications built against <code>libclang</code> aren&rsquo;t very portable or easy
to deploy because of dependencies on third party libraries like <a href="https://invisible-island.net/ncurses/">ncurses</a> and <a href="https://github.com/Z3Prover/z3">z3</a>.
Package managers do a decent job of orchestrating the install but it&rsquo;s still
hard to deploy an application that&rsquo;s pinned to a specific version of <code>libclang</code>
or to ship binaries between distributions. There&rsquo;s always containers or <a href="https://nixos.org/nix/">Nix</a> or
<a href="https://guix.gnu.org/">Guix</a> but to my mind asking people to get up to speed on purely functional
package managers or have <a href="https://www.docker.com/">Docker</a> running just to use <code>libclang</code> apps is a
non-starter. With this package all you need is <a href="https://cmake.org">CMake</a> but only initially to build
and install a static <code>libclang</code> archive; after that you can develop with simple
Makefiles if you like and ship users turn-key fat binaries with minimal
dependencies.
</p>
</div>
</div>
<div id="outline-container-org108dc6c" class="outline-2">
<h2 id="org108dc6c"><span class="section-number-2">3</span> Getting Started</h2>
<div class="outline-text-2" id="text-3">
<p>
First make sure you have a <code>cmake</code> version greater that 3.13:
</p>
<pre class="example">
&gt; cmake --version
cmake version 3.17.0

CMake suite maintained and supported by Kitware (kitware.com/cmake).
</pre>

<p>
Clone this repo, create a <code>build</code> directory inside it and run the build and install:
</p>
<pre class="example">
&gt; git clone https://github.com/deech/libclang-static-build
&gt; cd libclang-static-build
&gt; mkdir build; cd build
&gt; cmake .. -DCMAKE_INSTALL_PREFIX=..
# this downloads about 500MB of stuff into 'build' so depending on your network it might be a second or two ...
&gt; make install
</pre>

<p>
The <code>install</code> step copies all the artifacts to the directory into which you
cloned this repo just above the <code>build</code> directory. Nothing else on the system is
touched.
</p>

<p>
Once it&rsquo;s done installing there will be 3 new directories in repo directory,
<code>lib</code>, <code>include</code> and <code>doc</code>. The first contains the <code>libclang</code> static archive and some
other dependency libs, the second contains the <code>libclang</code> headers and the third
a small example program that walks a C++ header file containing an <code>enum</code> and a
Makefile that can be adapted to your needs. To build and run it:
</p>
<pre class="example">
&gt; cd libclang-static-build
&gt; cd doc/example/static
&gt; make
&gt; ./clang_visitor
Cursor spelling, kind: __ENUM__, macro definition
Cursor spelling, kind: Enum, EnumDecl
Cursor spelling, kind: RED, EnumConstantDecl
Cursor spelling, kind: , UnexposedExpr
Cursor spelling, kind: , IntegerLiteral
Cursor spelling, kind: , IntegerLiteral
Cursor spelling, kind: GREEN, EnumConstantDecl
Cursor spelling, kind: , UnexposedExpr
Cursor spelling, kind: , BinaryOperator
Cursor spelling, kind: , BinaryOperator
Cursor spelling, kind: , IntegerLiteral
Cursor spelling, kind: , IntegerLiteral
Cursor spelling, kind: BLUE, EnumConstantDecl
Cursor spelling, kind: , UnexposedExpr
Cursor spelling, kind: , BinaryOperator
Cursor spelling, kind: , BinaryOperator
Cursor spelling, kind: RED, DeclRefExpr
Cursor spelling, kind: GREEN, DeclRefExpr
</pre>

<p>
And that&rsquo;s it! The rest of this document is a literate program which explains
all the CMake scripts. It is only of interest if you want to get into
implementation details and can otherwise be skipped.
</p>
</div>
</div>

<div id="outline-container-org468c3da" class="outline-2">
<h2 id="org468c3da"><span class="section-number-2">4</span> Implementation</h2>
<div class="outline-text-2" id="text-4">
<p>
The overall strategy is to download the pre-built <code>libclang</code> for the current platform not so much for the <code>libclang.so</code> library itself but for all the statically linked LLVM libraries and CMake scripts that come with it, then retrieve the <code>clang</code> sources and compile only <code>libclang</code> bits locally into a static library and then use an <a href="https://sourceware.org/binutils/docs/binutils/ar-scripts.html">MRI script</a> to bundle it, the LLVM libs and other dependencies into an all-in-one static archive.
</p>

<p>
Those &ldquo;other dependencies&rdquo; are <a href="https://invisible-island.net/ncurses/announce.html">ncurses</a> and <a href="https://github.com/Z3Prover/z3">z3</a>. The latter is understandable, <code>clang</code> probably uses it for typechecking and fortunately the project releases prebuilt static archives for the major platforms but the former is super annoying and always seems to cause problems on Linux when upgrading so I compile and build a static archive in place and both get chucked into the final fat archive.
</p>

<p>
And finally there&rsquo;s an example app that gets generated and installed as well.
</p>
</div>
<div id="outline-container-orgceede4a" class="outline-3">
<h3 id="orgceede4a"><span class="section-number-3">4.1</span> Preamble</h3>
<div class="outline-text-3" id="text-4-1">
<p>
<code>3.13</code> is a relatively old version but it&rsquo;s what macOS Mojave ships with and it&rsquo;s enough.
</p>
<div class="org-src-container">
<pre class="src src-cmake"><span style="color: #006699;">cmake_minimum_required</span>(VERSION <span style="color: #D0372D;">3.13</span>)
<span style="color: #006699;">project</span>(libclang-linux-static)
<span style="color: #006699;">list</span>(APPEND CMAKE_MODULE_PATH <span style="color: #008000;">"${</span><span style="color: #BA36A5;">CMAKE_CURRENT_SOURCE_DIR</span><span style="color: #008000;">}/cmake/modules"</span>)
<span style="color: #006699;">set</span>(LIBCLANG_EXAMPLES <span style="color: #008000;">"${</span><span style="color: #BA36A5;">CMAKE_CURRENT_SOURCE_DIR</span><span style="color: #008000;">}/cmake/examples"</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-org4e26b51" class="outline-3">
<h3 id="org4e26b51"><span class="section-number-3">4.2</span> Clang and NCurses Download URLs</h3>
<div class="outline-text-3" id="text-4-2">
<p>
&ldquo;Reproducibility&rdquo; is achieved by hard-coding the URLs from which to get the dependencies, I&rsquo;m sure there&rsquo;s more principled ways but this works ok for now.
</p>
<div class="org-src-container">
<pre class="src src-cmake"><span style="color: #0000FF;">if</span>(APPLE)
  <span style="color: #006699;">set</span>(LIBCLANG_PREBUILT_URL https://github.com/llvm/llvm-project/releases/download/llvmorg-10.<span style="color: #D0372D;">0</span>.0/clang+llvm-10.<span style="color: #D0372D;">0</span>.0-x86_64-apple-darwin.tar.xz)
<span style="color: #0000FF;">else</span>()
  <span style="color: #006699;">set</span>(LIBCLANG_PREBUILT_URL https://github.com/llvm/llvm-project/releases/download/llvmorg-10.<span style="color: #D0372D;">0</span>.0/clang+llvm-10.<span style="color: #D0372D;">0</span>.0-x86_64-linux-gnu-ubuntu-18.<span style="color: #D0372D;">04</span>.tar.xz)
<span style="color: #0000FF;">endif</span>()
<span style="color: #006699;">set</span>(CLANG_SOURCES_URL https://github.com/llvm/llvm-project/releases/download/llvmorg-10.<span style="color: #D0372D;">0</span>.0/clang-10.<span style="color: #D0372D;">0.0</span>.src.tar.xz)
<span style="color: #006699;">set</span>(NCURSES_SOURCES_URL https://ftp.gnu.org/pub/gnu/ncurses/ncurses-6.<span style="color: #D0372D;">2</span>.tar.gz)
<span style="color: #0000FF;">if</span>(APPLE)
  <span style="color: #006699;">set</span>(Z3_PREBUILT_URL https://github.com/Z3Prover/z3/releases/download/z3-4.<span style="color: #D0372D;">8</span>.7/z3-4.<span style="color: #D0372D;">8</span>.7-x64-osx-10.<span style="color: #D0372D;">14.6</span>.zip)
<span style="color: #0000FF;">else</span>()
  <span style="color: #006699;">set</span>(Z3_PREBUILT_URL https://github.com/Z3Prover/z3/releases/download/z3-4.<span style="color: #D0372D;">8</span>.7/z3-4.<span style="color: #D0372D;">8</span>.7-x64-ubuntu-16.<span style="color: #D0372D;">04</span>.zip)
<span style="color: #0000FF;">endif</span>()
</pre>
</div>
</div>
</div>
<div id="outline-container-org8c512eb" class="outline-3">
<h3 id="org8c512eb"><span class="section-number-3">4.3</span> Download Libclang, NCurses and Z3</h3>
<div class="outline-text-3" id="text-4-3">
<p>
Now I download and unpack at <b>build</b> <b>time</b>, I should probably check the checksum too but whatever for now.
</p>
<div class="org-src-container">
<pre class="src src-cmake"><span style="color: #006699;">include</span>(Download)
<span style="color: #006699;">message</span>(STATUS <span style="color: #008000;">"Downloading ncurses sources, prebuilt z3 &amp; prebuilt libclang with sources; this is ~500MB, please be patient ..."</span>)
<span style="color: #006699;">set</span>(NCURSES_SOURCE_DIR)
<span style="color: #006699;">download</span>(ncurses_sources ${<span style="color: #BA36A5;">NCURSES_SOURCES_URL</span>} NCURSES_DOWNLOAD_DIR)
<span style="color: #006699;">set</span>(LIBCLANG_SOURCES_DIR)
<span style="color: #006699;">download</span>(clang_sources ${<span style="color: #BA36A5;">CLANG_SOURCES_URL</span>} LIBCLANG_SOURCES_DIR)
<span style="color: #006699;">set</span>(Z3_PREBUILT_DIR)
<span style="color: #006699;">download</span>(z3_prebuilt ${<span style="color: #BA36A5;">Z3_PREBUILT_URL</span>} Z3_PREBUILT_DIR)
<span style="color: #006699;">set</span>(LIBCLANG_PREBUILT_DIR)
<span style="color: #006699;">download</span>(libclang_prebuilt ${<span style="color: #BA36A5;">LIBCLANG_PREBUILT_URL</span>} LIBCLANG_PREBUILT_DIR)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc7a0b46" class="outline-3">
<h3 id="orgc7a0b46"><span class="section-number-3">4.4</span> Configure NCurses as an external project</h3>
<div class="outline-text-3" id="text-4-4">
<p>
<code>ncurses</code> does not provide prebuilt static archives so it is built in place. The build recipe is stolen from Arch scripts.
</p>
<div class="org-src-container">
<pre class="src src-cmake"><span style="color: #006699;">include</span>(ExternalProject)
<span style="color: #006699;">ExternalProject_Add</span>(ncurses
  SOURCE_DIR ${<span style="color: #BA36A5;">NCURSES_DOWNLOAD_DIR</span>}
  CONFIGURE_COMMAND &lt;SOURCE_DIR&gt;/configure --with-shared --with-static --with-normal --without-debug --without-ada --enable-widec --disable-pc-files --with-cxx-binding --without-cxx-shared --with-abi-version=5
  BUILD_COMMAND make
  INSTALL_COMMAND <span style="color: #008000;">""</span>
  )
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd71fb90" class="outline-3">
<h3 id="orgd71fb90"><span class="section-number-3">4.5</span> Setup CMake Paths And Includes</h3>
<div class="outline-text-3" id="text-4-5">
<p>
The first two lines are why I used CMake for this project in the first place, they contain useful functions and macros that take care of the nitty gritty C++ compiler and inclusion flags that allow building <code>libclang</code> from source, without them this project would have been impossible.
</p>
<div class="org-src-container">
<pre class="src src-cmake"><span style="color: #006699;">list</span>(APPEND CMAKE_MODULE_PATH <span style="color: #008000;">"${</span><span style="color: #BA36A5;">LIBCLANG_PREBUILT_DIR</span><span style="color: #008000;">}/lib/cmake/clang"</span>)
<span style="color: #006699;">list</span>(APPEND CMAKE_MODULE_PATH <span style="color: #008000;">"${</span><span style="color: #BA36A5;">LIBCLANG_PREBUILT_DIR</span><span style="color: #008000;">}/lib/cmake/llvm"</span>)
<span style="color: #006699;">list</span>(APPEND CMAKE_MODULE_PATH <span style="color: #008000;">"${</span><span style="color: #BA36A5;">LIBCLANG_SOURCES_DIR</span><span style="color: #008000;">}/cmake/modules"</span>)
<span style="color: #006699;">include</span>(LibClangBuild)
<span style="color: #006699;">include</span>(HandleLLVMOptions)
<span style="color: #006699;">include</span>(AddLLVM)
<span style="color: #006699;">include</span>(AddClang)
<span style="color: #006699;">include</span>(ARBundle)
</pre>
</div>
</div>
</div>
<div id="outline-container-orga2c72c8" class="outline-3">
<h3 id="orga2c72c8"><span class="section-number-3">4.6</span> Build A Static Libclang</h3>
<div class="outline-text-3" id="text-4-6">
<p>
First off I have to tell the C++ compiler to use C++14 features, this only seems to be required for macOS but doesn&rsquo;t hurt on the Linux side.
</p>
<div class="org-src-container">
<pre class="src src-cmake"><span style="color: #006699;">set</span>(CMAKE_CXX_STANDARD <span style="color: #D0372D;">14</span>)
<span style="color: #006699;">set</span>(CMAKE_CXX_STANDARD_REQUIRED ON)
</pre>
</div>

<p>
<code>get_libclang_sources_and_headers</code> populates the last three arguments with <span class="underline">absolute</span> paths to headers, <code>libclang</code> sources and the included LLVM archives.
</p>
<div class="org-src-container">
<pre class="src src-cmake"><span style="color: #006699;">get_libclang_sources_and_headers</span>(
  ${<span style="color: #BA36A5;">LIBCLANG_SOURCES_DIR</span>}
  ${<span style="color: #BA36A5;">LIBCLANG_PREBUILT_DIR</span>}
  LIBCLANG_SOURCES
  LIBCLANG_ADDITIONAL_HEADERS
  LIBCLANG_PREBUILT_LIBS
  )
</pre>
</div>

<p>
<code>add_clang_library</code> is a <code>libclang</code> provided CMake function that does all the hard work of generating Makefiles to build a <code>clang</code> and LLVM based library or executable. We use it twice, once to generate a static archive and once more for a shared library. While a shared library is generated I haven&rsquo;t gotten around to documenting it&rsquo;s use or providing examples so I don&rsquo;t mention it in <a href="#org108dc6c">Getting Started</a>.
</p>
<div class="org-src-container">
<pre class="src src-cmake"><span style="color: #006699;">include_directories</span>(${<span style="color: #BA36A5;">LIBCLANG_PREBUILT_DIR</span>}/include)
<span style="color: #006699;">add_clang_library</span>(libclang_static
  STATIC
  DEPENDS ncurses
  OUTPUT_NAME clang_static
  ${<span style="color: #BA36A5;">LIBCLANG_SOURCES</span>}
  ADDITIONAL_HEADERS ${<span style="color: #BA36A5;">LIBCLANG_ADDITIONAL_HEADERS</span>}
  )
<span style="color: #006699;">ExternalProject_Get_Property</span>(ncurses BINARY_DIR)
<span style="color: #006699;">set</span>(NCURSES_BINARY_DIR ${<span style="color: #BA36A5;">BINARY_DIR</span>})
<span style="color: #0000FF;">if</span>(APPLE)
  <span style="color: #006699;">set</span>(NCURSES_SHARED_LIB ${<span style="color: #BA36A5;">NCURSES_BINARY_DIR</span>}/lib/libncursesw.dylib)
<span style="color: #0000FF;">else</span>()
  <span style="color: #006699;">set</span>(NCURSES_SHARED_LIB ${<span style="color: #BA36A5;">NCURSES_BINARY_DIR</span>}/lib/libncursesw.so)
<span style="color: #0000FF;">endif</span>()
<span style="color: #006699;">unset</span>(BINARY_DIR)
<span style="color: #0000FF;">if</span>(APPLE)
  <span style="color: #006699;">set</span>(Z3_SHARED_LIB ${<span style="color: #BA36A5;">Z3_PREBUILT_DIR</span>}/bin/libz3.dylib)
<span style="color: #0000FF;">else</span>()
  <span style="color: #006699;">set</span>(Z3_SHARED_LIB ${<span style="color: #BA36A5;">Z3_PREBUILT_DIR</span>}/bin/libz3.so)
<span style="color: #0000FF;">endif</span>()
<span style="color: #006699;">add_clang_library</span>(libclang_shared
  SHARED
  DEPENDS ncurses
  OUTPUT_NAME clang_shared
  ${<span style="color: #BA36A5;">LIBCLANG_SOURCES</span>}
  ADDITIONAL_HEADERS ${<span style="color: #BA36A5;">LIBCLANG_ADDITIONAL_HEADERS</span>}
  LINK_LIBS
  ${<span style="color: #BA36A5;">LIBCLANG_PREBUILT_LIBS</span>}
  ${<span style="color: #BA36A5;">NCURSES_SHARED_LIB</span>}
  ${<span style="color: #BA36A5;">Z3_SHARED_LIB</span>}
  dl
  pthread
  z
  LINK_COMPONENTS ${<span style="color: #BA36A5;">LLVM_TARGETS_TO_BUILD</span>}
  )
<span style="color: #006699;">set_target_properties</span>(libclang_shared PROPERTIES VERSION <span style="color: #D0372D;">10</span>)
</pre>
</div>

<p>
<code>arBundle</code> generates the MRI script that takes all the required LLVM and dependency archives and creates a fat archive.
</p>
<div class="org-src-container">
<pre class="src src-cmake"><span style="color: #006699;">arBundle</span>(<span style="color: #008000;">"libclang_static_bundled.a"</span>
  ${<span style="color: #BA36A5;">CMAKE_CURRENT_BINARY_DIR</span>}/libclang_static.a
  ${<span style="color: #BA36A5;">LIBCLANG_PREBUILT_LIBS</span>}
  ${<span style="color: #BA36A5;">NCURSES_BINARY_DIR</span>}/lib/libncursesw.a
  ${<span style="color: #BA36A5;">Z3_PREBUILT_DIR</span>}/bin/libz3.a
  )
</pre>
</div>

<p>
For reasons I don&rsquo;t understand the &rsquo;ar&rsquo; utility provided by macOS does not support MRI script, <span class="underline">but</span> as luck would have it the prebuilt <code>libclang</code> also provides <code>llvm-ar</code> which is presumably an LLVM backed <code>ar</code> which does seem support MRI scripts and works out of the box. Hope they keep shipping it!
</p>
<div class="org-src-container">
<pre class="src src-cmake"><span style="color: #0000FF;">if</span>(APPLE)
  <span style="color: #006699;">set</span>(AR_COMMAND ${<span style="color: #BA36A5;">LIBCLANG_PREBUILT_DIR</span>}/bin/llvm-ar -M  &lt;${<span style="color: #BA36A5;">CMAKE_CURRENT_BINARY_DIR</span>}/bundle.mri)
<span style="color: #0000FF;">else</span>()
  <span style="color: #006699;">set</span>(AR_COMMAND ${<span style="color: #BA36A5;">CMAKE_AR</span>} -M &lt;${<span style="color: #BA36A5;">CMAKE_CURRENT_BINARY_DIR</span>}/bundle.mri)
<span style="color: #0000FF;">endif</span>()
</pre>
</div>

<p>
Now I can create the bundle target:
</p>
<div class="org-src-container">
<pre class="src src-cmake"><span style="color: #006699;">add_custom_target</span>(libclang_static_bundled ALL
  COMMAND ${<span style="color: #BA36A5;">AR_COMMAND</span>}
  DEPENDS ncurses libclang_static libclang_shared
  BYPRODUCTS ${<span style="color: #BA36A5;">CMAKE_CURRENT_BINARY_DIR</span>}/libclang_static_bundled.a
  )
</pre>
</div>

<p>
All the archives and dependencies have now been built and bundled so now we can generate the example app. The values of all the <code>MAKEFILE_BLAH_...</code> variables are spliced into the <a href="#org6c97d44">Static Makefile</a> wherever you see <code>@MAKEFILE_BLAH_...@</code>. That <code>CMAKE_OSX_SYSROOT</code> thing is simply so <code>libclang</code> headers can find the <code>time.h</code> on macOS. I&rsquo;m really not sure why it isn&rsquo;t in the standard location. Additionally on macOS the executable seems to need <code>libzlib</code> which didn&rsquo;t seem required on Linux. Again, shrug, no idea.
</p>
<div class="org-src-container">
<pre class="src src-cmake"><span style="color: #006699;">set</span>(MAKEFILE_LIBCLANG_INCLUDE ${<span style="color: #BA36A5;">CMAKE_INSTALL_PREFIX</span>}/include)
<span style="color: #0000FF;">if</span>(APPLE)
  <span style="color: #006699;">set</span>(MAKEFILE_LIBCLANG_INCLUDE <span style="color: #008000;">"${</span><span style="color: #BA36A5;">MAKEFILE_LIBCLANG_INCLUDE</span><span style="color: #008000;">} -I${</span><span style="color: #BA36A5;">CMAKE_OSX_SYSROOT</span><span style="color: #008000;">}/usr/include"</span>)
<span style="color: #0000FF;">endif</span>()
<span style="color: #006699;">set</span>(MAKEFILE_LIBCLANG_LIBDIR ${<span style="color: #BA36A5;">CMAKE_INSTALL_PREFIX</span>}/lib)
<span style="color: #0000FF;">if</span>(APPLE)
  <span style="color: #006699;">set</span>(MAKEFILE_LIBCLANG_LIBDIR <span style="color: #008000;">"${</span><span style="color: #BA36A5;">MAKEFILE_LIBCLANG_LIBDIR</span><span style="color: #008000;">} -lz"</span>)
<span style="color: #0000FF;">endif</span>()
<span style="color: #006699;">file</span>(MAKE_DIRECTORY ${<span style="color: #BA36A5;">CMAKE_CURRENT_BINARY_DIR</span>}/examples/static)
<span style="color: #006699;">configure_file</span>(${<span style="color: #BA36A5;">LIBCLANG_EXAMPLES</span>}/Makefile_static.in ${<span style="color: #BA36A5;">CMAKE_CURRENT_BINARY_DIR</span>}/examples/static/Makefile)
<span style="color: #006699;">file</span>(COPY ${<span style="color: #BA36A5;">LIBCLANG_EXAMPLES</span>}/clang_visitor.c DESTINATION ${<span style="color: #BA36A5;">CMAKE_CURRENT_BINARY_DIR</span>}/examples/static)
<span style="color: #006699;">file</span>(COPY ${<span style="color: #BA36A5;">LIBCLANG_EXAMPLES</span>}/sample.H DESTINATION ${<span style="color: #BA36A5;">CMAKE_CURRENT_BINARY_DIR</span>}/examples/static)
</pre>
</div>

<p>
And now I can set up the install targets and we&rsquo;re done!
</p>
<div class="org-src-container">
<pre class="src src-cmake"><span style="color: #006699;">set</span>(LIBCLANG_INSTALL_LIBS
  ${<span style="color: #BA36A5;">CMAKE_CURRENT_BINARY_DIR</span>}/libclang_static_bundled.a
  ${<span style="color: #BA36A5;">Z3_PREBUILT_DIR</span>}/bin/libz3.a
  ${<span style="color: #BA36A5;">Z3_SHARED_LIB</span>}
  ${<span style="color: #BA36A5;">NCURSES_BINARY_DIR</span>}/lib/libncursesw.a
  ${<span style="color: #BA36A5;">NCURSES_SHARED_LIB</span>}
  )
<span style="color: #006699;">install</span>(FILES ${<span style="color: #BA36A5;">LIBCLANG_INSTALL_LIBS</span>} DESTINATION lib)
<span style="color: #006699;">install</span>(DIRECTORY ${<span style="color: #BA36A5;">LIBCLANG_PREBUILT_DIR</span>}/include/clang-c DESTINATION include)
<span style="color: #006699;">install</span>(DIRECTORY ${<span style="color: #BA36A5;">CMAKE_CURRENT_BINARY_DIR</span>}/examples DESTINATION doc)
</pre>
</div>
</div>
</div>
<div id="outline-container-org1d61a27" class="outline-3">
<h3 id="org1d61a27"><span class="section-number-3">4.7</span> Helper Modules</h3>
<div class="outline-text-3" id="text-4-7">
</div>
<div id="outline-container-org752a060" class="outline-4">
<h4 id="org752a060"><span class="section-number-4">4.7.1</span> Build Time Downloads (Download.cmake)</h4>
<div class="outline-text-4" id="text-4-7-1">
<div class="org-src-container">
<pre class="src src-cmake"><span style="color: #006699;">include</span>(FetchContent)
<span style="color: #0000FF;">function</span> (download name url source_dir)
  <span style="color: #006699;">FetchContent_Declare</span>(${<span style="color: #BA36A5;">name</span>} URL ${<span style="color: #BA36A5;">url</span>})
  <span style="color: #0000FF;">if</span>(NOT ${<span style="color: #BA36A5;">name</span>}_POPULATED)
    <span style="color: #006699;">message</span>(STATUS <span style="color: #008000;">"* Downloading ${</span><span style="color: #BA36A5;">name</span><span style="color: #008000;">} from ${</span><span style="color: #BA36A5;">url</span><span style="color: #008000;">}"</span>)
    <span style="color: #006699;">FetchContent_Populate</span>(${<span style="color: #BA36A5;">name</span>})
  <span style="color: #0000FF;">endif</span>()
  <span style="color: #006699;">set</span>(${<span style="color: #BA36A5;">source_dir</span>} ${${<span style="color: #BA36A5;">name</span>}_SOURCE_DIR} PARENT_SCOPE)
<span style="color: #0000FF;">endfunction</span>()
</pre>
</div>
</div>
</div>
<div id="outline-container-org8ac8648" class="outline-4">
<h4 id="org8ac8648"><span class="section-number-4">4.7.2</span> Libclang sources, headers and static libs (LibClangBuild.cmake)</h4>
<div class="outline-text-4" id="text-4-7-2">
<p>
These are the LLVM dependencies needed to build <code>libclang</code>, most have been copied wholesale from the <code>CMakeLists.txt</code> provided with the project.
</p>
<div class="org-src-container">
<pre class="src src-cmake"><span style="color: #006699;">set</span>(LIBCLANG_SOURCE_PATH tools/libclang)
<span style="color: #006699;">set</span>(LIBCLANG_INCLUDE_PATH include/clang-c)
<span style="color: #006699;">set</span>(LIBCLANG_SOURCE_FILES
  ARCMigrate.cpp
  BuildSystem.cpp
  CIndex.cpp
  CIndexCXX.cpp
  CIndexCodeCompletion.cpp
  CIndexDiagnostic.cpp
  CIndexHigh.cpp
  CIndexInclusionStack.cpp
  CIndexUSRs.cpp
  CIndexer.cpp
  CXComment.cpp
  CXCursor.cpp
  CXIndexDataConsumer.cpp
  CXCompilationDatabase.cpp
  CXLoadedDiagnostic.cpp
  CXSourceLocation.cpp
  CXStoredDiagnostic.cpp
  CXString.cpp
  CXType.cpp
  Indexing.cpp
  FatalErrorHandler.cpp
)
<span style="color: #006699;">set</span>(LIBCLANG_ADDITIONAL_HEADER_FILES
  CIndexDiagnostic.h
  CIndexer.h
  CXCursor.h
  CXLoadedDiagnostic.h
  CXSourceLocation.h
  CXString.h
  CXTranslationUnit.h
  CXType.h
  Index_Internal.h
)
<span style="color: #006699;">set</span>(LIBCLANG_INDEX_H Index.h)
</pre>
</div>

<p>
But this list took some experimentation, apparently we need all these libraries and in this approximate order for a <code>libclang</code> app to statically link correctly, I have no idea why I just tried stuff until it worked.
</p>
<div class="org-src-container">
<pre class="src src-cmake"><span style="color: #006699;">set</span>(LIBCLANG_LINK_LIBS
  clangAST
  clangBasic
  clangDriver
  clangFrontend
  clangIndex
  clangLex
  clangSema
  clangSerialization
  clangTooling
  clangARCMigrate
  LLVMAArch64CodeGen
  LLVMAArch64AsmParser
  LLVMAArch64Desc
  LLVMAArch64Disassembler
  LLVMAArch64Info
  LLVMAArch64Utils
  LLVMAMDGPUCodeGen
  LLVMAMDGPUAsmParser
  LLVMAMDGPUDesc
  LLVMAMDGPUDisassembler
  LLVMAMDGPUInfo
  LLVMAMDGPUUtils
  LLVMARMCodeGen
  LLVMARMAsmParser
  LLVMARMDesc
  LLVMARMDisassembler
  LLVMARMInfo
  LLVMARMUtils
  LLVMBPFCodeGen
  LLVMBPFAsmParser
  LLVMBPFDesc
  LLVMBPFDisassembler
  LLVMBPFInfo
  LLVMHexagonCodeGen
  LLVMHexagonAsmParser
  LLVMHexagonDesc
  LLVMHexagonDisassembler
  LLVMHexagonInfo
  LLVMLanaiCodeGen
  LLVMLanaiAsmParser
  LLVMLanaiDesc
  LLVMLanaiDisassembler
  LLVMLanaiInfo
  LLVMMipsCodeGen
  LLVMMipsAsmParser
  LLVMMipsDesc
  LLVMMipsDisassembler
  LLVMMipsInfo
  LLVMMSP430CodeGen
  LLVMMSP430AsmParser
  LLVMMSP430Desc
  LLVMMSP430Disassembler
  LLVMMSP430Info
  LLVMNVPTXCodeGen
  LLVMNVPTXDesc
  LLVMNVPTXInfo
  LLVMPowerPCCodeGen
  LLVMPowerPCAsmParser
  LLVMPowerPCDesc
  LLVMPowerPCDisassembler
  LLVMPowerPCInfo
  LLVMRISCVCodeGen
  LLVMRISCVAsmParser
  LLVMRISCVDesc
  LLVMRISCVDisassembler
  LLVMRISCVInfo
  LLVMRISCVUtils
  LLVMSparcCodeGen
  LLVMSparcAsmParser
  LLVMSparcDesc
  LLVMSparcDisassembler
  LLVMSparcInfo
  LLVMSystemZCodeGen
  LLVMSystemZAsmParser
  LLVMSystemZDesc
  LLVMSystemZDisassembler
  LLVMSystemZInfo
  LLVMWebAssemblyCodeGen
  LLVMWebAssemblyAsmParser
  LLVMWebAssemblyDesc
  LLVMWebAssemblyDisassembler
  LLVMWebAssemblyInfo
  LLVMX86CodeGen
  LLVMX86AsmParser
  LLVMX86Desc
  LLVMX86Disassembler
  LLVMX86Info
  LLVMX86Utils
  LLVMXCoreCodeGen
  LLVMXCoreDesc
  LLVMXCoreDisassembler
  LLVMXCoreInfo
  LLVMCore
  LLVMSupport
  clangFormat
  clangToolingInclusions
  clangToolingCore
  clangFrontend
  clangDriver
  LLVMOption
  clangParse
  clangSerialization
  clangSema
  clangEdit
  clangRewrite
  clangAnalysis
  clangASTMatchers
  clangAST
  clangLex
  clangBasic
  LLVMAArch64Desc
  LLVMAArch64Info
  LLVMAArch64Utils
  LLVMMIRParser
  LLVMAMDGPUDesc
  LLVMAMDGPUInfo
  LLVMAMDGPUUtils
  LLVMARMDesc
  LLVMARMInfo
  LLVMARMUtils
  LLVMHexagonDesc
  LLVMHexagonInfo
  LLVMLanaiDesc
  LLVMLanaiInfo
  LLVMipo
  LLVMVectorize
  LLVMIRReader
  LLVMAsmParser
  LLVMInstrumentation
  LLVMLinker
  LLVMSystemZDesc
  LLVMSystemZInfo
  LLVMWebAssemblyDesc
  LLVMWebAssemblyInfo
  LLVMGlobalISel
  LLVMAsmPrinter
  LLVMDebugInfoDWARF
  LLVMSelectionDAG
  LLVMCodeGen
  LLVMScalarOpts
  LLVMAggressiveInstCombine
  LLVMInstCombine
  LLVMBitWriter
  LLVMTransformUtils
  LLVMTarget
  LLVMAnalysis
  LLVMProfileData
  LLVMTextAPI
  LLVMObject
  LLVMBitReader
  LLVMCore
  LLVMRemarks
  LLVMBitstreamReader
  LLVMMCParser
  LLVMMCDisassembler
  LLVMMC
  LLVMBinaryFormat
  LLVMDebugInfoCodeView
  LLVMDebugInfoMSF
  LLVMSupport
  LLVMCFGuard
  LLVMFrontendOpenMP
  LLVMDemangle
  )
</pre>
</div>
</div>
</div>
<div id="outline-container-orgeb94d87" class="outline-4">
<h4 id="orgeb94d87"><span class="section-number-4">4.7.3</span> Add absolute path to sources and headers (LibClangBuild.cmake)</h4>
<div class="outline-text-4" id="text-4-7-3">
<div class="org-src-container">
<pre class="src src-cmake"><span style="color: #0000FF;">function</span>(get_libclang_sources_and_headers clang_source_path clang_prebuilt_path result_sources result_headers result_required_libs)
  <span style="color: #006699;">list</span>(TRANSFORM LIBCLANG_SOURCE_FILES PREPEND ${<span style="color: #BA36A5;">clang_source_path</span>}/${<span style="color: #BA36A5;">LIBCLANG_SOURCE_PATH</span>}/ OUTPUT_VARIABLE RES)
  <span style="color: #006699;">set</span>(${<span style="color: #BA36A5;">result_sources</span>} ${<span style="color: #BA36A5;">RES</span>} PARENT_SCOPE)
  <span style="color: #006699;">unset</span>(RES)
  <span style="color: #006699;">list</span>(TRANSFORM LIBCLANG_ADDITIONAL_HEADER_FILES PREPEND ${<span style="color: #BA36A5;">clang_source_path</span>}/${<span style="color: #BA36A5;">LIBCLANG_SOURCE_PATH</span>}/ OUTPUT_VARIABLE RES)
  <span style="color: #006699;">list</span>(TRANSFORM LIBCLANG_INDEX_H PREPEND ${<span style="color: #BA36A5;">clang_source_path</span>}/${<span style="color: #BA36A5;">LIBCLANG_INCLUDE_PATH</span>}/ OUTPUT_VARIABLE RES1)
  <span style="color: #006699;">list</span>(APPEND RES ${<span style="color: #BA36A5;">RES1</span>})
  <span style="color: #006699;">set</span>(${<span style="color: #BA36A5;">result_headers</span>} ${<span style="color: #BA36A5;">RES</span>} PARENT_SCOPE)
  <span style="color: #006699;">unset</span>(RES)
  <span style="color: #006699;">list</span>(TRANSFORM LIBCLANG_LINK_LIBS PREPEND ${<span style="color: #BA36A5;">clang_prebuilt_path</span>}/lib/lib OUTPUT_VARIABLE RES)
  <span style="color: #006699;">list</span>(TRANSFORM RES APPEND .a OUTPUT_VARIABLE RES)
  <span style="color: #006699;">set</span>(${<span style="color: #BA36A5;">result_required_libs</span>} ${<span style="color: #BA36A5;">RES</span>} PARENT_SCOPE)
  <span style="color: #006699;">unset</span>(RES)
<span style="color: #0000FF;">endfunction</span>()
</pre>
</div>
</div>
</div>
<div id="outline-container-org3a7b179" class="outline-4">
<h4 id="org3a7b179"><span class="section-number-4">4.7.4</span> Build AR Bundling Script (ARBundle.cmake)</h4>
<div class="outline-text-4" id="text-4-7-4">
<div class="org-src-container">
<pre class="src src-cmake"><span style="color: #0000FF;">function</span> (arBundle lib)
  <span style="color: #006699;">set</span>(FILE ${<span style="color: #BA36A5;">CMAKE_CURRENT_BINARY_DIR</span>}/bundle.mri)
  <span style="color: #006699;">file</span>(WRITE ${<span style="color: #BA36A5;">FILE</span>} <span style="color: #008000;">"CREATE ${</span><span style="color: #BA36A5;">lib</span><span style="color: #008000;">}\n"</span>)
  <span style="color: #0000FF;">foreach</span>(lib ${<span style="color: #BA36A5;">ARGN</span>})
    <span style="color: #006699;">file</span>(APPEND ${<span style="color: #BA36A5;">FILE</span>} <span style="color: #008000;">"ADDLIB ${</span><span style="color: #BA36A5;">lib</span><span style="color: #008000;">}\n"</span>)
  <span style="color: #0000FF;">endforeach</span>()
  <span style="color: #006699;">file</span>(APPEND ${<span style="color: #BA36A5;">FILE</span>} <span style="color: #008000;">"SAVE\n"</span>)
  <span style="color: #006699;">file</span>(APPEND ${<span style="color: #BA36A5;">FILE</span>} <span style="color: #008000;">"END"</span>)
<span style="color: #0000FF;">endfunction</span>()
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orga32cdbf" class="outline-3">
<h3 id="orga32cdbf"><span class="section-number-3">4.8</span> Examples</h3>
<div class="outline-text-3" id="text-4-8">
</div>
<div id="outline-container-org6c97d44" class="outline-4">
<h4 id="org6c97d44"><span class="section-number-4">4.8.1</span> Static Makefile</h4>
<div class="outline-text-4" id="text-4-8-1">
<div class="org-src-container">
<pre class="src src-makefile"><span style="color: #BA36A5;">CC</span>=@CMAKE_C_COMPILER@
<span style="color: #BA36A5;">CFLAGS</span>=-I@MAKEFILE_LIBCLANG_INCLUDE@
<span style="color: #BA36A5;">LIBS</span>=-L@MAKEFILE_LIBCLANG_LIBDIR@ -lclang_static_bundled -lstdc++ -lm -ldl -lpthread
<span style="color: #BA36A5;">OBJ</span>=clang_visitor.o

<span style="color: #0000ff; font-weight: bold;">%.o</span>: %.c
    $(<span style="color: #BA36A5;">CC</span>) -c -o <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #D0372D; font-weight: bold;">@</span> $<span style="color: #D0372D;">&lt;</span> $(<span style="color: #BA36A5;">CFLAGS</span>)

<span style="color: #0000ff; font-weight: bold;">clang_visitor</span>: $(<span style="color: #BA36A5;">OBJ</span>)
    $(<span style="color: #BA36A5;">CC</span>) -o <span style="color: #0000ff; font-weight: bold;">$</span><span style="color: #D0372D; font-weight: bold;">@</span> $<span style="color: #D0372D;">^</span> $(<span style="color: #BA36A5;">CFLAGS</span>) $(<span style="color: #BA36A5;">LIBS</span>)

<span style="color: #0000ff; font-weight: bold;">.PHONY</span>: clean

<span style="color: #0000ff; font-weight: bold;">clean</span>:
    rm *.o clang_visitor
</pre>
</div>
</div>
</div>
<div id="outline-container-org577874d" class="outline-4">
<h4 id="org577874d"><span class="section-number-4">4.8.2</span> Example Visitor</h4>
<div class="outline-text-4" id="text-4-8-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">clang-c/Index.h</span><span style="color: #707183;">&gt;</span>
<span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">clang-c/CXString.h</span><span style="color: #707183;">&gt;</span>
<span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">stdio.h</span><span style="color: #707183;">&gt;</span>
<span style="color: #808080;">#include</span> <span style="color: #707183;">&lt;</span><span style="color: #008000;">stdlib.h</span><span style="color: #707183;">&gt;</span>

<span style="color: #0000FF;">enum</span> <span style="color: #6434A3;">CXChildVisitResult</span> <span style="color: #006699;">visitor</span><span style="color: #707183;">(</span><span style="color: #6434A3;">CXCursor</span> <span style="color: #BA36A5;">cursor</span>, <span style="color: #6434A3;">CXCursor</span> <span style="color: #BA36A5;">parent</span>, <span style="color: #6434A3;">CXClientData</span> <span style="color: #BA36A5;">data</span><span style="color: #707183;">)</span> <span style="color: #707183;">{</span>
    <span style="color: #6434A3;">CXSourceLocation</span> <span style="color: #BA36A5;">location</span> = clang_getCursorLocation<span style="color: #7388D6;">(</span> cursor <span style="color: #7388D6;">)</span>;
    <span style="color: #0000FF;">if</span><span style="color: #7388D6;">(</span>!clang_Location_isFromMainFile<span style="color: #909183;">(</span>location<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>
        <span style="color: #0000FF;">return</span> CXChildVisit_Continue;
    <span style="color: #6434A3;">CXString</span> <span style="color: #BA36A5;">cxspelling</span> = clang_getCursorSpelling<span style="color: #7388D6;">(</span>cursor<span style="color: #7388D6;">)</span>;
    <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span>* <span style="color: #BA36A5;">spelling</span> = clang_getCString<span style="color: #7388D6;">(</span>cxspelling<span style="color: #7388D6;">)</span>;
    <span style="color: #6434A3;">CXString</span> <span style="color: #BA36A5;">cxkind</span> = clang_getCursorKindSpelling<span style="color: #7388D6;">(</span>clang_getCursorKind<span style="color: #909183;">(</span>cursor<span style="color: #909183;">)</span><span style="color: #7388D6;">)</span>;
    <span style="color: #0000FF;">const</span> <span style="color: #6434A3;">char</span>* <span style="color: #BA36A5;">kind</span> = clang_getCString<span style="color: #7388D6;">(</span>cxkind<span style="color: #7388D6;">)</span>;
    printf<span style="color: #7388D6;">(</span><span style="color: #008000;">"Cursor spelling, kind: %s, %s\n"</span>, spelling, kind<span style="color: #7388D6;">)</span>;
    clang_disposeString<span style="color: #7388D6;">(</span>cxspelling<span style="color: #7388D6;">)</span>;
    clang_disposeString<span style="color: #7388D6;">(</span>cxkind<span style="color: #7388D6;">)</span>;
    <span style="color: #0000FF;">return</span> CXChildVisit_Recurse;
<span style="color: #707183;">}</span>

<span style="color: #6434A3;">int</span> <span style="color: #006699;">main</span><span style="color: #707183;">(</span><span style="color: #6434A3;">int</span> <span style="color: #BA36A5;">argc</span>, <span style="color: #6434A3;">char</span>** <span style="color: #BA36A5;">argv</span><span style="color: #707183;">)</span> <span style="color: #707183;">{</span>
    <span style="color: #6434A3;">CXIndex</span> <span style="color: #BA36A5;">idx</span> = clang_createIndex<span style="color: #7388D6;">(</span><span style="color: #D0372D;">1</span>,<span style="color: #D0372D;">1</span><span style="color: #7388D6;">)</span>;
    <span style="color: #6434A3;">CXTranslationUnit</span> <span style="color: #BA36A5;">tu</span> = clang_createTranslationUnitFromSourceFile<span style="color: #7388D6;">(</span>idx, <span style="color: #008000;">"sample.H"</span>, <span style="color: #D0372D;">0</span>, <span style="color: #D0372D;">0</span>, <span style="color: #D0372D;">0</span>, <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span>;
    clang_visitChildren<span style="color: #7388D6;">(</span>clang_getTranslationUnitCursor<span style="color: #909183;">(</span>tu<span style="color: #909183;">)</span>, visitor, <span style="color: #D0372D;">0</span><span style="color: #7388D6;">)</span>;
    <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">0</span>;
<span style="color: #707183;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc298424" class="outline-4">
<h4 id="orgc298424"><span class="section-number-4">4.8.3</span> Sample C++ File</h4>
<div class="outline-text-4" id="text-4-8-3">
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #808080;">#if</span><span style="color: #808080;">n</span><span style="color: #808080;">def</span> <span style="color: #D0372D;">__ENUM__</span>
<span style="color: #808080;">#define</span> <span style="color: #BA36A5;">__ENUM__</span>

<span style="color: #0000FF;">enum</span> <span style="color: #6434A3;">Enum</span>
<span style="color: #707183;">{</span>
  <span style="color: #BA36A5;">RED</span> = <span style="color: #D0372D;">10</span>,
  <span style="color: #BA36A5;">GREEN</span> = <span style="color: #D0372D;">10</span> &lt;&lt; <span style="color: #D0372D;">2</span>,
  <span style="color: #BA36A5;">BLUE</span> = <span style="color: #D0372D;">RED</span> + <span style="color: #D0372D;">GREEN</span>
<span style="color: #707183;">}</span>;


<span style="color: #808080;">#endif</span> <span style="color: #8D8D84;">// </span><span style="color: #8D8D84; font-style: italic;">__ENUM__</span>
</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Aditya Siram</p>
</div>
</body>
</html>
